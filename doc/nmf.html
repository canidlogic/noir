<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Noir Music File (NMF) specification</title>
        <style>

body {
  margin: auto;
  max-width: 40em;
}

:link {
  text-decoration: none;
  color: blue
}

:visited {
  text-decoration: none;
  color: blue
}

#toc {
  border: thin solid;
  float: left;
  padding: 0.5em;
  margin-bottom: 1.5em;
}

#tochead {
  margin-top: 0;
  text-align: center;
  font-weight: bold;
}

#toclast {
  margin-bottom: 0;
}

#headfirst {
  clear: both;
}

    </style>
  </head>
  <body>

<h1>Noir Music File (NMF) specification</h1>

<p>Noah Johnson<br/>
<a href="http://www.canidtech.com/">www.canidtech.com</a><br/>
January 17, 2020 | 3Y:A4-5</p>

<div id="toc">
<p id="tochead">Table of Contents</p>

<p>1. <a href="#sec1">Introduction</a></p>

<p>2. <a href="#sec2">Data types</a><br/>
&nbsp;&nbsp;2.1 <a href="#sec2p1">Unsigned 32-bit integer</a><br/>
&nbsp;&nbsp;2.2 <a href="#sec2p2">Biased 32-bit integer</a><br/>
&nbsp;&nbsp;2.3 <a href="#sec2p3">Unsigned 16-bit integer</a><br/>
&nbsp;&nbsp;2.4 <a href="#sec2p4">Biased 16-bit integer</a><br/></p>

<p id="toclast">3. <a href="#sec3">Quanta</a><br/>
4. <a href="#sec4">File header</a><br/>
5. <a href="#sec5">Section table</a><br/>
6. <a href="#sec6">Note table</a></p>
</div>

<h2 id="headfirst"><a name="sec1">1. Introduction</a></h2>

<p>The Noir Music Format (NMF) is a binary file format that is designed to store the results of interpreting a Noir notation file.  (See the Noir notation specification for more information about Noir notation.)  While Noir notation is a text format that is designed to be written manually by the user, NMF is designed to be easy to access from computer programs.</p>

<p>The intended architecture is that there is a Noir compilation program that converts Noir notation into binary NMF, and then all other Noir programs use the NMF file, saving them from having to interpret the textual Noir notation.</p>

<h2><a name="sec2">2. Data types</a></h2>

<p>This section documents the data types used in NMF and how they are stored in an NMF byte stream.</p>

<h3><a name="sec2p1">2.1 Unsigned 32-bit integer</a></h3>

<p>An unsigned 32-bit integer is stored with four bytes in big endian order, with the most significant byte first and the least significant byte last.  The most significant bit of the integer must always be zero, so the range is zero up to and including 2,147,483,647.</p>

<h3><a name="sec2p2">2.2 Biased 32-bit integer</a></h3>

<p>A biased 32-bit integer is stored with four bytes in big endian order, with the most significant byte first and the least significant byte last.  The most significant bit need not be zero, but at least one bit must be non-zero, so the raw numeric range is one up to and including 4,294,967,295.</p>

<p>The actual value stored in the biased integer is the raw numeric value subtracted by 2,147,483,648.  This results in an actual value range of -2,147,483,647 up to and including 2,147,483,647.</p>

<h3><a name="sec2p3">2.3 Unsigned 16-bit integer</a></h3>

<p>An unsigned 16-bit integer is stored with two bytes in big endian order, with the most significant byte first and the least significant byte second.  The most significant bit of the integer need not be zero, so the range is zero up to and including 65,535.</p>

<h3><a name="sec2p4">2.4 Biased 16-bit integer</a></h3>

<p>A biased 16-bit integer is stored with two bytes in big endian order, with the most significant byte first and the least significant byte second.  The most significant bit of the integer need not be zero, but at least one bit must be non-zero, so the range is one up to and including 65,535.</p>

<p>The actual value stored in the baised integer is the raw numeric value subtracted by 32,768.  This results in an actual value range of -32,767 up to and including 32,767.</p>

<h2><a name="sec3">3. Quanta</a></h2>

<p>Rhythm and time units are counted in <i>quanta</i>.  A quantum is a variable-length duration that varies depending on the tempo.  96 quanta are equivalent to a quarter note.  See the Noir notation specification for further information.</p>

<h2><a name="sec4">4. File header</a></h2>

<p>An NMF file begins with the following header:</p>

<ol>
<li>[Unsigned 32-bit integer] <b>Primary signature</b></li>
<li>[Unsigned 32-bit integer] <b>Secondary signature</b></li>
<li>[Unsigned 32-bit integer] <b>Section count</b></li>
<li>[Unsigned 32-bit integer] <b>Note count</b></li>
</ol>

<p>The primary signature must be the value 1,928,196,216.  The secondary signature must be the value 1,313,818,926.  If these two signatures are not present with those values, then the file is not an NMF file.</p>

<p>The section count is the total number of sections in the section table (see &sect;5 <a href="#sec5">Section table</a>).  The range of the section count is one up to and including 65,536.</p>

<p>The note count is the total number of notes in the note table (see &sect;6 <a href="#sec6">Note table</a>).  The range of the note count is one up to and including 1,048,576.</p>

<h2><a name="sec5">5. Section table</a></h2>

<p>The section table stores the starting offset of each section in the composition.  The total number of sections is given in the file header (see &sect;4 <a href="#sec4">File header</a>).</p>

<p>The section table has one unsigned 32-bit integer for each section.  Each integer indicates how many quanta have elapsed from the start of the composition up to the start of the section.  The first section must always have a value of zero, meaning it starts at the beginning of the composition.</p>

<p>If there is more than one section, each section after the first must have a starting offset that is greater than or equal to the starting offset of the previous section.</p>

<p>The section index of a particular section is its zero-based index in the section table.  Therefore, the first section has section index zero, the second section has section index one, and so forth.  Each note in the note table (see &sect;6 <a href="#sec6">Note table</a>) has a section index identifying which section it belongs to.  All notes in a section must have starting offsets that are greater than or equal to the starting offset of the section given in the section table.</p>

<p>Note that earlier sections may overlap with later sections.  That is, an event in section 2 might take place after an event in section 3, for example.</p>

<h2><a name="sec6">6. Note table</a></h2>

<p>The note table stores all the notes of the composition.  The total number of notes is given in the file header (see &sect;4 <a href="#sec4">File header</a>).  Each note has the following structure:</p>

<ol>
<li>[Unsigned 32-bit integer] <b>Time offset</b></li>
<li>[Biased 32-bit integer] <b>Duration</b></li>
<li>[Biased 16-bit integer] <b>Pitch</b></li>
<li>[Unsigned 16-bit integer] <b>Articulation</b></li>
<li>[Unsigned 16-bit integer] <b>Section index</b></li>
<li>[Unsigned 16-bit integer] <b>Layer index</b></li>
</ol>

<p>The notes in the note table must be sorted such that the time offsets are in ascending order.  Furthermore, for notes that have equal time offsets, the durations must be sorted in ascending order.  No other sorting guarantees are made.</p>

<p>The time offset is the number of quanta from the beginning of the composition to the note, with zero meaning the note occurs at the beginning of the composition.  The time offset does not include any grace note offset (see below), which may shift the note to a position before the indicated time offset.  The time offset must be greater than or equal to the starting offset of the section this note belongs to (see below).</p>

<p>The duration has a different meaning depending on whether it is greater than zero, zero, or less than zero.  If greater than zero, it is the duration of the note in quanta.  If less than zero, the note is a grace note and the absolute value of the duration indicates how far from the upcoming beat the grace note is.  That is, -1 means the grace note immediately before the beat, -2 means the grace note before the grace note at offset -1, -3 means the grace note before the note at offset -2, and so forth.  A duration of zero is never generated from Noir notation, but it is reserved for cue events and other special meanings.</p>

<p>The pitch is the number of semitones (half steps) away from middle C.  A value of zero means middle C, a value of -1 means B below middle C, a value of 2 means D above middle C, and so forth.  The valid range is [-39, 48], which covers all pitches on the 88-key piano keyboard.</p>

<p>The articulation is the type of articulation applied to the note.  Articulation zero is the default articulation.  The valid range is [0, 61].  NMF does not specify the meaning of any particular articulation.</p>

<p>The section index must be in range [0, max], where <i>max</i> is one less than the section count given in the header.  The section index selects a particular section entry in the section table.  The time offset of the note must be greater than or equal to the starting offset of the section.</p>

<p>The layer index selects a layer within the particular section specified for this note.  The layer index is one less than the layer number, so a value of zero selects layer one within this section, one selects layer two within this section, and so forth.</p>

<div style="margin-top: 2.5em;">&nbsp;</div>

  </body>
</html>